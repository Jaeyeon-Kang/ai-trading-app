# 바스켓 기반 라우팅 시스템 개선 계획

## 📋 개요

GPT 분석 결과에 따라 개별주 1:1 라우팅의 치명적 문제점을 해결하기 위한 바스켓 기반 집계 시스템으로 전환

## 🔴 기존 문제점

1. **논리적 모순**: 개별주 하락 ≠ 지수 하락
2. **포지션 집중**: 모든 숏 신호가 SQQQ로 집중
3. **중복 매수**: 1초에 SQQQ 10회+ 매수 시도
4. **상충 포지션**: QQQ 롱과 SQQQ 롱 동시 보유 가능
5. **체결률 0.13%**: 잘못된 진단과 해결책

## ✅ 새로운 바스켓 기반 시스템

### 1. 바스켓 정의

```python
BASKETS = {
    "MEGATECH": {
        "tickers": {"AAPL", "MSFT", "AMZN", "META", "GOOGL", "TSLA"},
        "etf": "SQQQ",  # NASDAQ-100 인버스
        "min_signals": 3,  # 최소 3개 종목에서 신호
        "neg_fraction": 0.60  # 60% 이상 음수
    },
    "SEMIS": {
        "tickers": {"NVDA", "AMD", "AVGO"},
        "etf": "SOXS",  # 반도체 인버스
        "min_signals": 2,
        "neg_fraction": 0.66
    }
}
```

### 2. 집계 조건 (모두 충족 필요)

- **집단성**: 바스켓 내 60% 이상 종목이 음수 신호
- **강도**: 평균 스코어 ≤ -0.12
- **지속성**: 2틱(60초) 연속 확인
- **추세**: 하락 기울기 (3분 윈도우)

### 3. ETF 단일 락 시스템

```python
# Redis 기반 락 (90초 TTL)
etf_lock:{symbol} = 1  # in-flight 상태
position:{symbol} = qty  # 보유 포지션

# 규칙:
- 락이 있으면 추가 매수 금지
- 이미 포지션 있으면 피라미딩 1회만 허용
- 피라미딩 조건: 추가 하락 확인 + 리스크 여유
```

### 4. 상충 포지션 금지

```python
CONFLICTS = {
    "SQQQ": ["QQQ"],      # NASDAQ 롱/숏 동시 금지
    "SOXS": ["SOXL", "SOXX"],  # 반도체 롱/숏 동시 금지
    "SPXS": ["SPY"],      # S&P 500 롱/숏 동시 금지
}
```

## 🚀 구현 단계

### Phase 1: 월요일 핫픽스 (즉시 적용)

1. **라우팅 함수 수정**
   - route_signal_symbol_FIXED() 구현
   - 바스켓 집계 로직 추가
   - 인버스 ETF는 패스스루

2. **중복 매수 차단**
   - ETF 단일 락 구현
   - 포지션 체크 로직

3. **리스크 파라미터 임시 축소**
   - RISK_PER_TRADE: 0.5% → 0.2%
   - MAX_CONCURRENT_RISK: 2% → 1%

4. **브래킷 주문 활성화**
   - 손절: max(1.5%, 0.7×ATR)
   - 익절: 1.5R

### Phase 2: 구조적 개선 (주중)

1. **파이프라인 재설계**
   - 개별 신호 → 바스켓 집계 → 단일 실행
   - 집계 레이어 별도 구현

2. **ETF 네이티브 신호**
   - ETF 자체 가격/볼륨 분석
   - 보조 확인 신호로 활용

## 📊 모니터링 지표

### 실시간 추적
- route_reason: 라우팅 이유
- suppress_reason: 억제 이유
- lock_block: 락 차단 횟수
- conflict_block: 상충 차단 횟수
- basket_state: 바스켓 상태

### 시간당 리포트
- actionable/체결/억제 분포
- flip-flop 횟수
- stopout 비율
- 총 리스크 사용률 (목표 ≤1%)

## ⚠️ 주의사항

1. **예시 코드 주의**: GPT 제공 코드는 예시일 뿐, 실제 시스템에 맞게 수정 필요
2. **점진적 적용**: 큰 리팩토링 없이 핫픽스부터 시작
3. **롤백 준비**: 문제 발생 시 즉시 원복 가능하도록 준비
4. **로그 강화**: 모든 결정 포인트에 상세 로그 추가

## 🎯 기대 효과

1. **논리적 일관성**: 집단 움직임에만 베팅
2. **리스크 분산**: 단일 ETF 집중 방지
3. **중복 제거**: 동일 ETF 반복 매수 차단
4. **체결률 개선**: 품질 높은 신호만 실행
5. **자본 보호**: 상충 포지션으로 인한 손실 방지

## 📅 일정

- **2025-08-19 오전**: 핫픽스 구현 및 테스트
- **2025-08-19 저녁**: 월요일 라이브 테스트
- **2025-08-20~22**: 구조적 개선 진행
- **2025-08-23**: Phase 2 완료 및 평가

---

*이 계획은 GPT 분석을 바탕으로 작성되었으며, 실제 구현 시 시스템 특성에 맞게 조정됩니다.*